
CashBackAPI

This api was made using fastapi:

    'pip install -r requirements.txt'

Start the API:

    Run the main.py or type 'uvicorn main:app --reload' on terminal

The fastapi have Interactive API docs, available on:

    http://127.0.0.1:8000/docs

This interactive doc builds a web interface, so you can test the CashBackAPI. Access the docs, and you will see that three functions are available:

    GET  ReadRoot
    POST RequestNewToken
    POST RequestCashback

ReadRoot : Just sends a GET request to CashBackAPI that will return a "Hello World!" it's up
    
    On http://127.0.0.1:8000/docs page, click on 'Request New Token' header, then click in 'Try it out'

    Then you will see the Curl generated by the interactive API, the request URL, the response
    
RequestNewToken : Simulate an API client trying to get an authentication token from CashbackAPI

    On http://127.0.0.1:8000/docs page, click on 'Request New Token' header, then click in 'Try it out'

    type username = 'jonhdoe', and password = 'secret', then click on "Execute"

    What this documentation makes is equivalent to building the request:

        curl -X 'POST' \
            'http://127.0.0.1:8000/token' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d 'grant_type=&username=johndoe&password=secret&scope=&client_id=&client_secret='

    The response will be a JSON with the authorization token that the client will use in the next communications
            
        {
            "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJqb2huZG9lIiwiZXhwIjoxNjM3MTAzMzEyfQ.xT39ywLb4avQQVT_afObGq5u1bGoG5dA8yC7O_NYadk",
            "token_type": "bearer"
        }   
    
RequestCashBack : Simulate the client sending a cashback transaction information and requesting a cashback

    On http://127.0.0.1:8000/docs page, click on 'Request CashBack' header, then click in 'Try it out'

    Put a cashback a transaction

        {
            "sold_at": "2021-11-16T22:18:40.979105+00:00",
            "customer": {"customer_name": "string", "customer_cpf": "VALIDCPF"},
            "products": [{"category": "books", "quantity": 10, "value": 1}], 
            "total": 10
        }

    This will generate the curl:
        curl -X 'POST' \
            'http://127.0.0.1:8000/api/cashback/' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -d '{
            "sold_at": "2021-11-16T22:18:40.979105+00:00",
            "customer": {
                "customer_name": "string",
                "customer_cpf": "VALIDCPF"
            },
            "products": [
                {
                "category": "books",
                "quantity": 10,
                "value": 1
                }
            ],
            "total": 10
            }'

    Then click on "Execute". The server will return:
        {
            "detail": "Not authenticated"
        }

    This is because we don't put our access token, nor do we have a field for it, but here's a little trick, click the "Authorize" button on the top right of the API DOC page, put in the credentials username = 'johndoe' and password = 'secret', click on "authorize". This will request a new token by calling the "Request New Token" from behind the scenes, and manually inserting the received token into each curl that needs it.
        curl -X 'POST' \
            'http://127.0.0.1:8000/api/cashback/' \
            -H 'accept: application/json' \
            -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJqb2huZG9lIiwiZXhwIjoxNjM3MTA0OTcwfQ.fwNERQq4ko1z8JOYHILlo_6uOwvWGdF_UK4-Mefwl08' \
            -H 'Content-Type: application/json' \
            -d '{
            "sold_at": "2021-11-16T22:18:40.979105+00:00",
            "customer": {
                "customer_name": "string",
                "customer_cpf": "string"
            },
            "products": [
                {
                "category": "string",
                "quantity": 0,
                "value": 0
                }
            ],
            "total": 0
            }'

    Put a valid CPF, non-negative quantities, non-negative values, and a valid category ('books', 'clothes', 'electronics') in products, then you will successfully send valid cashback information to CashBackAPI.

    Thy to put an invalid quantity, for example, you will see the response:

        {
        "detail": [
            {
            "loc": [
                "body",
                "products",
                0,
                "value"
            ],
            "msg": "negative value",
            "type": "value_error"
            },
            {
            "loc": [
                "body",
                "total"
            ],
            "msg": "invalid products",
            "type": "value_error"
            }
        ]
        }

    This is because the parameters received by the API are used to instantiate objects and every object used in API implements tests with pydantic @validator. The JSON in parameter '-d' will be internally converted to a CashBackTransaction object (defined on models.py). If any parameter of the object doesn't pass in an internal @validator of the class, then the request will be refused.
    
        
TESTS

    pytest
